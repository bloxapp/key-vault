package encoderv2

import (
	"encoding/base64"
	"encoding/hex"
	"math/rand"
	"testing"

	"github.com/bloxapp/key-vault/keymanager/models"

	"github.com/prysmaticlabs/go-bitfield"

	types "github.com/prysmaticlabs/prysm/consensus-types/primitives"

	"github.com/stretchr/testify/require"

	eth "github.com/prysmaticlabs/prysm/proto/prysm/v1alpha1"
)

func _byteArray(input string) []byte {
	res, _ := hex.DecodeString(input)
	return res
}

func TestV2(t *testing.T) {
	t.Run("attestation data", func(t *testing.T) {
		attestationDataByts := _byteArray("000000000000000000000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776b0000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776b")
		attData := &eth.AttestationData{}
		require.NoError(t, attData.UnmarshalSSZ(attestationDataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestAttestationData{AttestationData: attData},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetAttestationData().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, attestationDataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("beacon block", func(t *testing.T) {
		dataByts := _byteArray("010000000000000055000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776badd5cb7e6a4bffd8ce7fe9697aed511661861e312ad546dcf5480159698f47a554000000a2c156a4bc9439f1d85f922f2abaa96e830f1c526101211bdb7d16f4ad9490a0302fc5adb089c05b5f16fd465962f47c04fc2b81a94d135a07c1613db61511c17284b51fafab984e56d3411e16e45f5068f146d9412f91d31ab0f237eac3d745a4e544482366bc9d5386f1cd0c4bf837327605620bf40c5514d51dfcadd14a4a8000000000000000a4e544482366bc9d5386f1cd0c4bf837327605620bf40c5514d51dfcadd14a4a0000000000000000000000000000000000000000000000000000000000000000dc000000dc000000dc000000c5010000c501000004000000e4000000000000000000000000000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776b97b6f271ac364b041cd465f32fa7ffa19f5a811f1e6e14713f93e06537ef827d382bac72f0990b84f83cd9bbe0062815020086bf27b9ced172cc6add8ba5197991cf634d18666f5d43df6f09180ce20a357e4d05b2784409e32147f1042986e31f")
		data := &eth.BeaconBlock{}
		require.NoError(t, data.UnmarshalSSZ(dataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestBlock{Block: data},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetBlock().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, dataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("beacon block altair", func(t *testing.T) {
		dataByts := _byteArray("01000000000000001c00000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c83387dd0abb441a3c16886c8144098cb4cac5e363516f329c368550094fd7ff754000000b1e2f27dfac80e4f1bce84adf11acf6cdbb0d8e59a575c9795020e614eb3aa29634108c0559c04ce02b93fc9a5a8daf60485ebac039864c79d51bef54915aa8c45cbcde3215f14962be196a6b8648851c35b4a804ce8d5fb6c5ff49800ef7740685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb732000000000000000685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb7300000000000000000000000000000000000000000000000000000000000000007c0100007c0100007c0100006502000065020000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa2ec291dd5e91096ae48b3659a7ac59567a48c030bb6ac9435d6d44ef39f3f664742f35b38cd6e41ade9ed417183cc0c0b407dfea8627ccc2275fc82ab3d2182e58a037eb144811d741d18894698396efde2b7873c2db9b712e03dfcd03705ef04000000e400000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669cb62ce3f28e8731dce73d5761fdc5e30383d42a022d6e939974d0586d82270f79b38b86d17237e4241a761e239c594e7a0d4ef731470001be3b125ba515f8f215f9309a9ba12653bf9d704a4125865b9775c8a65223e3ca027781175200a2d24403")
		data := &eth.BeaconBlockAltair{}
		require.NoError(t, data.UnmarshalSSZ(dataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestBlockV2{BlockV2: data},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetBlockV2().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, dataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("beacon block bellatrix", func(t *testing.T) {
		dataByts := _byteArray("1027000000000000b2d6000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd3dc77754974a255d1e94021c323b04a498e3c5898bfd6b57e76c969a195c65d5c5400000096b3e1eb732fc98e131d6e6c0fe7bfc5e13983005007d48ca3d205ef78d847094d03cdfe326efdb0aaddd4802e23e5e605804cc1484cca30dc42afb9d031f92dcb08e393612b42c3af172ded8c1ebffca15ec4595ea903194d31fd320e19561ed70a234731285c6804c2a4f56711ddb8c82c99740f207854891028af34e27e5e00000000000000000000000000000000000000000000000000000000000000000000000000000000707279736d2d6765746800000000000000000000000000000000000000000000800100008001000080010000d1190000d1190000fffeffffeef7ffffffffff7ff7ffdfefdefffff7ffffff4ffbffffe7f7ffefffffef75ffeffbffffffeef7fffbfff6fffefffffeffffeff77f7ffffffeffffdba4875770cd59e728c8875969bb65912e371c3a86a1a04876887a8f084333333964789b8d85403269efd624ba2b81d8180dcfc3dd7537c0dc2e7b2854c8f4d76765a7492c3ede2e128a4e4bef528e28a1e6247e7b4be5881f5747bb1976db021fd119000064000000590100004e02000043030000380400002d05000022060000170700000c08000001090000f6090000eb0a0000e00b0000d50c0000ca0d0000bf0e0000b40f0000a91000009e11000093120000881300007d14000072150000671600005c170000e40000000f270000000000000000000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8e9bbe3d00e63c05a270efd189a6eb8f20afed7ccacb045e5de940992fe0ab81a9a40cbe429929f76fb059df4a3c27e708e22a7849a7a1b725b68ee1546ec604c00403d9197aca568ee6c1d5d2694fb282656f845e8111a6ef6551006181a73bfffffffffffbffffffdfffffffffffff1fe40000000f270000000000001100000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb3dffe029baae6bea92e6eac8a4ecc4cf6dc07977d2f6ce22b05989ec68cf0922bbd30a50e3c156c54ca53d2d8eabb690d1d386fad0e54cda4d78f473a90736bde3d02481bc613779914cdb952b198f41ce4d4c82a1ee7a427d7a4689838e02af3feffedfffffff7ffffffffffdfbffd1fe40000000f270000000000000400000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8f6206001b2b47be99767b3b1fdb2a813959b0b74b36dcce712b76416477b943db291c1b979aefb3f9aeb177b814cff217ac690bd232b77f078b9534c0ceca711de27f3d48359d72f62ac16f1bce6ee2130ad741d8e48270de5cc9c7381cb36cbfffffffffffffffdbffffffffffffff1fe40000000f270000000000000800000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfea215c3799dc59cb8a17f209d100344782b5e947591b0db6c75db2b29c5d3a7cc4f3211a730ae9c0d39cfbad8099c1c67132593e91a5ae3282c3a8c2c91b109c57219bcfc178e9ff594345da7a89be2fdd496375d2f8aadd08b59d78e9321627effffffffffffffff7fffff7feffffbff1fe40000000f270000000000000f00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb602d97673b43cc70122676e899d457efcd979167b27b314439ba7f5c0f43f28a0817304236d17e723e48a8ff55023ca140b860dd19cfe73fa549462ab4091515fef48dcd5b3d4a871d341c46e196b007288e383e7a970efea3650e5ab5ed316ffdffbefffff7fffffffffffffffffff1fe40000000f270000000000001300000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb896ff9a59f2d512aee7e0bdbc4a4958a59e9a7e1b9218a10618afac35ada39f5d2b46067586954941463d7cbad207b9094973863b712f65cbcbc92cf6d769ab591d513196153f95a62620ca198bbe8539fc40c2bde3d1a8c9df5d38d4c2b488fffffff7ffeffff7ffffbfff7fffffff1fe40000000f270000000000000300000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe98dc641bdcd2ca58ef6dbec797fca07cd3e518883591edbd835d6d35043518c3e7ac075212b7692e1bc4fadb266eafb602149cd51b9bb4b91e445fd89e03a70241fd444bdf5ad6458e339d955b2566e57bd0fd63471f6515df3877dfea326a09fffffffbefffefffffffffffefffffff0fe40000000f270000000000000e00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb1d1e7a27130406e7c9be5b55a2250a85c6c53ba12ecfaaf75efb8d7662f9caad7ee005c4ec63db821500662d3db63820e62aa7dcd87a97c777924b241d23ffbc3f866510479c2dfe411c2424c8446a5865e6429b60d7e09bbc5748e80c465b0fd5fffffffffffffffffdfffffffffff0fe40000000f270000000000001800000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfea88d93eef307e27acecf0a9ad31b8dc10b1b94d526f05e5a7ce22909c8b8debf72cddca037da503c3e76061ed366f0b3048bc4a2f06c4ea481446631b52b4d441b133dc77894fd02e6506d4deea29637c8ee2e8e664112a77a95cd495b8966c6ff7fffbdfeffffffeffffffffff7ffff1fe40000000f270000000000000d00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb10aee16d2a87e2bd45f6b081bb2fbdf7e5d858ec5717eb4bcdb6ff810ef961141d9c86b313d6e1a6a34a67d52e049af11acee7549acbdbbb21673bf12673295eefdbd9033be3e881d03038961725b6da16827387df154342541332baae8c0caf7f7efffffffff7ffffff7ffffff7fff1fe40000000f270000000000000900000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8a80b13913a1b0adcccc788d38dea67b90fec55416a178741956cc7518b3588724f91eed0a91125f087a5dd1d08e97a708ee0aeadacedbdeebbc9e6e33c7da31c624534a5d049535211ff1365a926b5f3db73ec39ab2606137861adc81ee810cfffffffffffffffffffeefff5ffffffb0fe40000000f270000000000000c00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe95232e0f207bad3ee268a9d8b231c8a14ced0c69a07a6e5c1d9007405b74370490b654f8ad9d7db00156a0f91974c07413815eadb89cb97d43eb4939f8c0a62b9312cbe00916329086fa05e12a358edbbe39fdfd18338ec1dd6b1337b42360cefdffdfffffffff7fff7ff7ffffffffff0fe40000000f270000000000001700000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe9760928d938490b4b734031ea3f239c66d6f9e89178eb434e12d0462b33bd12dce81bfb557bfa9f4de654511935ec917197b5a7355ae2f265c60f31ddde0938b1320e27571475eeb5a095507009e43ae7c1649f4e6ced7c493653775c4e25ccefebfffffffeffff7fffffffffffefff71fe40000000f270000000000000a00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe856ce0e394cad31d800b678c7113628d8a547a448c897abbc2f6756b1c0983448df4d883cb8ecd1dde0b54590710ca5f0481217d1dffa8cb876a4e0e935bbc25dd597bf013857a18604bb4d6d7ad162dd3d7f26399c73bcaad0e308a29fc08f2dffdffffbfd7ffffffff7ffffeffffff1fe40000000f270000000000000200000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8b19927f74c743cd9a758bca5bbecbc6eb7620aa27bd494cfe5cef9bf715cb13bf47568b365be59d0f067b882f565bb80b1281aa481f675f98f2269b7cc8ac4e98d4fa7e0446da9060a3cc4126600a00bb3049912216abe85642826739cd74b7dffffefffbefffbffbfffffffffffffb1fe40000000f270000000000001400000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8e22174655f7c6123861b9c6a8e7664131cc6c5c274702ee0306ea34323146fc721b34d040f19c58a2ddf1a90166ea9d02efa7da8b829c5ca12170bd811d5fa7eb62f1f4d68c00cade4ae8949bd8a128531f93df0590446b5f0a579e854df1d1fffffffffe6fffffffffffffffffff5f0ee40000000f270000000000000100000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8d3fc240c142cfd69ffcd778b295c9b7e3691c13310bea151ffe6fc23b0af9423b94f4fddf66c11e0849f50af351be700df92647e78f3d6043fdc009ad9015714cdbae4c67bbf8c4cf75c0be24392f07005794fe49d21e36b19c13bfcebc01d2ffffffbffdfffbffffdffffffffffbff0de40000000f270000000000000600000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeae2b171686a23f3cf7a1a2c986645315c552385cbdd8d8e26565d0a15a5decdee15aab2bab3b3d19d361aa32494d9f4219fb1da9041567a93c4c9d2236f106b2e8637222771702bff61a3090aae7b3c96c6b7f9b099af4d593949d873f01cf06ffffcfffff57ffbffff7fffffffffeff1fe40000000f270000000000001600000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe985ad2e75104b814a25f0ad32e8cbac0013f5e35c6cda8a58931b15d9f2d050c96c43f8b7d97ca31ddfade46a9031eb111c21116bc2c9fd0e669653f2978149a874055698a38dc6ae2dcf985d5a77aa001935dd518d226b642ea9f433a9e00caff7fffefdbfffdffffffdffffffeffff0fe40000000f270000000000001500000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfea65479903594fefaa2cf9101d3f6c7950685409371f218ee304949c8ff0a790475e044c647a51be627d3d8381490bd19026bcedb98bb556d3b61f98e8b5d104ac48c151858183af3c84569d812a553943c7d81032ae9ea1a5bd5fa05fd08b91efefffffffffffffffdfbbffbe7dfffff1fe40000000f270000000000001200000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb166412ca8e5accde6a0b7556554473022e6caf3c4f6bc33ccb86d6ec63fd34fe97037f4a08818467a221db991fbfd0514598ac8d903df34c8f6b9a277efbeb899ddf478e803ec7a95f56569d8e671c485cba7bd693b715ae4a2aa9a72359f34f7dfffffffffffb7ff7ffffff9feffff0fe40000000f270000000000000700000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe95cdf25245a0ae301d0ac3b0ca3a6d8c1eb555e29b7303929fb40ae02b30f57bc636a849a01e4f16adef86bff1f7dae2040ac3a7fbf9ae4fc3c96d928a7c86223f912b55cb912a33471fa090750782ade302e1e826a7928d810e5e105029f80bffffeffefffffffafffbfaffffbfffff0fe40000000f270000000000000500000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfea6fe408e83618c093abc551be8944ad00c040a5d38c6514d2086a149d9485b0899c236c5755c8c263150fe7e595bada1140a3f4484885dc9cfccec53a53be949d6dc53a647f8697a128e61cd5226a77a75f6e3dcb6ea09d32ac0090b3a778a17fdfedbffffffffbf6fbdfffffffff7ff0fe40000000f270000000000000b00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb5071a523ee2e87991997eb6de7372039f941ec28de0a7a37db7ca03934f85788d2bb52e8a322d62689a480fa173c4a901b5e0eccd3ec4f750507834fe492a3c2f32069e51f46dbabc98f396a854f3c6a4cdfd7c2226a4f472512176c49d4c43ddffffffffefffffbd7fddfffdff7ffe1fe40000000f270000000000001000000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8231c0636d4be8c77b18863cd981b0832c2832cf4be5e7aa55b37e9fe6d742936a3b98e390226683a021d5f57417bbff18116e0ae6a04136d79419c421bb6c28b328c5bd619e06d12af583a628b2cb6d5d21ec8494b1ba630ae071daf961d492e7effff67fffffffffeff7ffbeffbf7f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fc01000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fc010000")
		data := &eth.BeaconBlockBellatrix{}
		require.NoError(t, data.UnmarshalSSZ(dataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestBlockV3{BlockV3: data},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetBlockV3().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, dataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("blinded beacon block bellatrix", func(t *testing.T) {
		dataByts, err := base64.StdEncoding.DecodeString("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")
		require.NoError(t, err)
		data := &eth.BlindedBeaconBlockBellatrix{}
		require.NoError(t, data.UnmarshalSSZ(dataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestBlindedBlockV3{BlindedBlockV3: data},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetBlindedBlockV3().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, dataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("attestation aggregation", func(t *testing.T) {
		dataByts := _byteArray("01000000000000001c00000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c83387dd0abb441a3c16886c8144098cb4cac5e363516f329c368550094fd7ff754000000b1e2f27dfac80e4f1bce84adf11acf6cdbb0d8e59a575c9795020e614eb3aa29634108c0559c04ce02b93fc9a5a8daf60485ebac039864c79d51bef54915aa8c45cbcde3215f14962be196a6b8648851c35b4a804ce8d5fb6c5ff49800ef7740685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb732000000000000000685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb7300000000000000000000000000000000000000000000000000000000000000007c0100007c0100007c0100006502000065020000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa2ec291dd5e91096ae48b3659a7ac59567a48c030bb6ac9435d6d44ef39f3f664742f35b38cd6e41ade9ed417183cc0c0b407dfea8627ccc2275fc82ab3d2182e58a037eb144811d741d18894698396efde2b7873c2db9b712e03dfcd03705ef04000000e400000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669cb62ce3f28e8731dce73d5761fdc5e30383d42a022d6e939974d0586d82270f79b38b86d17237e4241a761e239c594e7a0d4ef731470001be3b125ba515f8f215f9309a9ba12653bf9d704a4125865b9775c8a65223e3ca027781175200a2d24403")
		data := &eth.BeaconBlockAltair{}
		require.NoError(t, data.UnmarshalSSZ(dataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestBlockV2{BlockV2: data},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetBlockV2().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, dataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("slot", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestSlot{Slot: 2},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, types.Slot(2), decoded.GetSlot())
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("epoch", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestEpoch{Epoch: 2},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, types.Epoch(2), decoded.GetEpoch())
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("sync committee", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestSyncCommitteeMessage{Root: []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.GetSyncCommitteeMessage())
	})
	t.Run("sync aggregator", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object: &models.SignRequestSyncAggregatorSelectionData{
				SyncAggregatorSelectionData: &eth.SyncAggregatorSelectionData{
					Slot:              types.Slot(12),
					SubcommitteeIndex: 44,
				},
			},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, 12, decoded.GetSyncAggregatorSelectionData().Slot)
		require.EqualValues(t, 44, decoded.GetSyncAggregatorSelectionData().SubcommitteeIndex)
	})
	t.Run("sync contribution proof", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object: &models.SignRequestContributionAndProof{
				ContributionAndProof: &eth.ContributionAndProof{
					AggregatorIndex: types.ValidatorIndex(12),
					SelectionProof:  make([]byte, 96),
					Contribution: &eth.SyncCommitteeContribution{
						Slot:              11,
						BlockRoot:         []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
						SubcommitteeIndex: 12,
						AggregationBits:   bitfield.NewBitvector128(),
						Signature:         make([]byte, 96),
					},
				},
			},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, 12, decoded.GetContributionAndProof().AggregatorIndex)
		require.EqualValues(t, make([]byte, 96), decoded.GetContributionAndProof().SelectionProof)
		require.EqualValues(t, 11, decoded.GetContributionAndProof().Contribution.Slot)
		require.EqualValues(t, 12, decoded.GetContributionAndProof().Contribution.SubcommitteeIndex)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.GetContributionAndProof().Contribution.BlockRoot)
	})
	t.Run("validator registration", func(t *testing.T) {
		pk := make([]byte, 48)
		rand.Read(pk)
		feeRecipient := make([]byte, 20)
		rand.Read(feeRecipient)

		req := &models.SignRequest{
			PublicKey:       pk,
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object: &models.SignRequestRegistration{
				Registration: &eth.ValidatorRegistrationV1{
					FeeRecipient: feeRecipient,
					GasLimit:     100,
					Timestamp:    123456,
					Pubkey:       pk,
				},
			},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, feeRecipient, decoded.GetRegistration().FeeRecipient)
		require.EqualValues(t, 100, decoded.GetRegistration().GasLimit)
		require.EqualValues(t, 123456, decoded.GetRegistration().Timestamp)
		require.EqualValues(t, pk, decoded.GetRegistration().Pubkey)
	})
}
