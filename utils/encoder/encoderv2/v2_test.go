package encoderv2

import (
	"encoding/hex"
	"testing"

	"github.com/bloxapp/key-vault/keymanager/models"

	"github.com/prysmaticlabs/go-bitfield"

	types "github.com/prysmaticlabs/eth2-types"

	"github.com/stretchr/testify/require"

	eth "github.com/prysmaticlabs/prysm/proto/prysm/v1alpha1"
)

func _byteArray(input string) []byte {
	res, _ := hex.DecodeString(input)
	return res
}

func TestV2(t *testing.T) {
	t.Run("attestation data", func(t *testing.T) {
		attestationDataByts := _byteArray("000000000000000000000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776b0000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776b")
		attData := &eth.AttestationData{}
		require.NoError(t, attData.UnmarshalSSZ(attestationDataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestAttestationData{AttestationData: attData},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetAttestationData().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, attestationDataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("beacon block", func(t *testing.T) {
		dataByts := _byteArray("010000000000000055000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776badd5cb7e6a4bffd8ce7fe9697aed511661861e312ad546dcf5480159698f47a554000000a2c156a4bc9439f1d85f922f2abaa96e830f1c526101211bdb7d16f4ad9490a0302fc5adb089c05b5f16fd465962f47c04fc2b81a94d135a07c1613db61511c17284b51fafab984e56d3411e16e45f5068f146d9412f91d31ab0f237eac3d745a4e544482366bc9d5386f1cd0c4bf837327605620bf40c5514d51dfcadd14a4a8000000000000000a4e544482366bc9d5386f1cd0c4bf837327605620bf40c5514d51dfcadd14a4a0000000000000000000000000000000000000000000000000000000000000000dc000000dc000000dc000000c5010000c501000004000000e4000000000000000000000000000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003a43a4bf26fb5947e809c1f24f7dc6857c8ac007e535d48e6e4eca2122fd776b97b6f271ac364b041cd465f32fa7ffa19f5a811f1e6e14713f93e06537ef827d382bac72f0990b84f83cd9bbe0062815020086bf27b9ced172cc6add8ba5197991cf634d18666f5d43df6f09180ce20a357e4d05b2784409e32147f1042986e31f")
		data := &eth.BeaconBlock{}
		require.NoError(t, data.UnmarshalSSZ(dataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestBlock{Block: data},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetBlock().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, dataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("beacon block altair", func(t *testing.T) {
		dataByts := _byteArray("01000000000000001c00000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c83387dd0abb441a3c16886c8144098cb4cac5e363516f329c368550094fd7ff754000000b1e2f27dfac80e4f1bce84adf11acf6cdbb0d8e59a575c9795020e614eb3aa29634108c0559c04ce02b93fc9a5a8daf60485ebac039864c79d51bef54915aa8c45cbcde3215f14962be196a6b8648851c35b4a804ce8d5fb6c5ff49800ef7740685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb732000000000000000685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb7300000000000000000000000000000000000000000000000000000000000000007c0100007c0100007c0100006502000065020000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa2ec291dd5e91096ae48b3659a7ac59567a48c030bb6ac9435d6d44ef39f3f664742f35b38cd6e41ade9ed417183cc0c0b407dfea8627ccc2275fc82ab3d2182e58a037eb144811d741d18894698396efde2b7873c2db9b712e03dfcd03705ef04000000e400000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669cb62ce3f28e8731dce73d5761fdc5e30383d42a022d6e939974d0586d82270f79b38b86d17237e4241a761e239c594e7a0d4ef731470001be3b125ba515f8f215f9309a9ba12653bf9d704a4125865b9775c8a65223e3ca027781175200a2d24403")
		data := &eth.BeaconBlockAltair{}
		require.NoError(t, data.UnmarshalSSZ(dataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestBlockV2{BlockV2: data},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetBlockV2().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, dataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("beacon block bellatrix", func(t *testing.T) {
		dataByts := _byteArray("1027000000000000b2d6000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd3dc77754974a255d1e94021c323b04a498e3c5898bfd6b57e76c969a195c65d5c5400000096b3e1eb732fc98e131d6e6c0fe7bfc5e13983005007d48ca3d205ef78d847094d03cdfe326efdb0aaddd4802e23e5e605804cc1484cca30dc42afb9d031f92dcb08e393612b42c3af172ded8c1ebffca15ec4595ea903194d31fd320e19561ed70a234731285c6804c2a4f56711ddb8c82c99740f207854891028af34e27e5e00000000000000000000000000000000000000000000000000000000000000000000000000000000707279736d2d6765746800000000000000000000000000000000000000000000800100008001000080010000d1190000d1190000fffeffffeef7ffffffffff7ff7ffdfefdefffff7ffffff4ffbffffe7f7ffefffffef75ffeffbffffffeef7fffbfff6fffefffffeffffeff77f7ffffffeffffdba4875770cd59e728c8875969bb65912e371c3a86a1a04876887a8f084333333964789b8d85403269efd624ba2b81d8180dcfc3dd7537c0dc2e7b2854c8f4d76765a7492c3ede2e128a4e4bef528e28a1e6247e7b4be5881f5747bb1976db021fd119000064000000590100004e02000043030000380400002d05000022060000170700000c08000001090000f6090000eb0a0000e00b0000d50c0000ca0d0000bf0e0000b40f0000a91000009e11000093120000881300007d14000072150000671600005c170000e40000000f270000000000000000000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8e9bbe3d00e63c05a270efd189a6eb8f20afed7ccacb045e5de940992fe0ab81a9a40cbe429929f76fb059df4a3c27e708e22a7849a7a1b725b68ee1546ec604c00403d9197aca568ee6c1d5d2694fb282656f845e8111a6ef6551006181a73bfffffffffffbffffffdfffffffffffff1fe40000000f270000000000001100000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb3dffe029baae6bea92e6eac8a4ecc4cf6dc07977d2f6ce22b05989ec68cf0922bbd30a50e3c156c54ca53d2d8eabb690d1d386fad0e54cda4d78f473a90736bde3d02481bc613779914cdb952b198f41ce4d4c82a1ee7a427d7a4689838e02af3feffedfffffff7ffffffffffdfbffd1fe40000000f270000000000000400000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8f6206001b2b47be99767b3b1fdb2a813959b0b74b36dcce712b76416477b943db291c1b979aefb3f9aeb177b814cff217ac690bd232b77f078b9534c0ceca711de27f3d48359d72f62ac16f1bce6ee2130ad741d8e48270de5cc9c7381cb36cbfffffffffffffffdbffffffffffffff1fe40000000f270000000000000800000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfea215c3799dc59cb8a17f209d100344782b5e947591b0db6c75db2b29c5d3a7cc4f3211a730ae9c0d39cfbad8099c1c67132593e91a5ae3282c3a8c2c91b109c57219bcfc178e9ff594345da7a89be2fdd496375d2f8aadd08b59d78e9321627effffffffffffffff7fffff7feffffbff1fe40000000f270000000000000f00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb602d97673b43cc70122676e899d457efcd979167b27b314439ba7f5c0f43f28a0817304236d17e723e48a8ff55023ca140b860dd19cfe73fa549462ab4091515fef48dcd5b3d4a871d341c46e196b007288e383e7a970efea3650e5ab5ed316ffdffbefffff7fffffffffffffffffff1fe40000000f270000000000001300000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb896ff9a59f2d512aee7e0bdbc4a4958a59e9a7e1b9218a10618afac35ada39f5d2b46067586954941463d7cbad207b9094973863b712f65cbcbc92cf6d769ab591d513196153f95a62620ca198bbe8539fc40c2bde3d1a8c9df5d38d4c2b488fffffff7ffeffff7ffffbfff7fffffff1fe40000000f270000000000000300000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe98dc641bdcd2ca58ef6dbec797fca07cd3e518883591edbd835d6d35043518c3e7ac075212b7692e1bc4fadb266eafb602149cd51b9bb4b91e445fd89e03a70241fd444bdf5ad6458e339d955b2566e57bd0fd63471f6515df3877dfea326a09fffffffbefffefffffffffffefffffff0fe40000000f270000000000000e00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb1d1e7a27130406e7c9be5b55a2250a85c6c53ba12ecfaaf75efb8d7662f9caad7ee005c4ec63db821500662d3db63820e62aa7dcd87a97c777924b241d23ffbc3f866510479c2dfe411c2424c8446a5865e6429b60d7e09bbc5748e80c465b0fd5fffffffffffffffffdfffffffffff0fe40000000f270000000000001800000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfea88d93eef307e27acecf0a9ad31b8dc10b1b94d526f05e5a7ce22909c8b8debf72cddca037da503c3e76061ed366f0b3048bc4a2f06c4ea481446631b52b4d441b133dc77894fd02e6506d4deea29637c8ee2e8e664112a77a95cd495b8966c6ff7fffbdfeffffffeffffffffff7ffff1fe40000000f270000000000000d00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb10aee16d2a87e2bd45f6b081bb2fbdf7e5d858ec5717eb4bcdb6ff810ef961141d9c86b313d6e1a6a34a67d52e049af11acee7549acbdbbb21673bf12673295eefdbd9033be3e881d03038961725b6da16827387df154342541332baae8c0caf7f7efffffffff7ffffff7ffffff7fff1fe40000000f270000000000000900000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8a80b13913a1b0adcccc788d38dea67b90fec55416a178741956cc7518b3588724f91eed0a91125f087a5dd1d08e97a708ee0aeadacedbdeebbc9e6e33c7da31c624534a5d049535211ff1365a926b5f3db73ec39ab2606137861adc81ee810cfffffffffffffffffffeefff5ffffffb0fe40000000f270000000000000c00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe95232e0f207bad3ee268a9d8b231c8a14ced0c69a07a6e5c1d9007405b74370490b654f8ad9d7db00156a0f91974c07413815eadb89cb97d43eb4939f8c0a62b9312cbe00916329086fa05e12a358edbbe39fdfd18338ec1dd6b1337b42360cefdffdfffffffff7fff7ff7ffffffffff0fe40000000f270000000000001700000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe9760928d938490b4b734031ea3f239c66d6f9e89178eb434e12d0462b33bd12dce81bfb557bfa9f4de654511935ec917197b5a7355ae2f265c60f31ddde0938b1320e27571475eeb5a095507009e43ae7c1649f4e6ced7c493653775c4e25ccefebfffffffeffff7fffffffffffefff71fe40000000f270000000000000a00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe856ce0e394cad31d800b678c7113628d8a547a448c897abbc2f6756b1c0983448df4d883cb8ecd1dde0b54590710ca5f0481217d1dffa8cb876a4e0e935bbc25dd597bf013857a18604bb4d6d7ad162dd3d7f26399c73bcaad0e308a29fc08f2dffdffffbfd7ffffffff7ffffeffffff1fe40000000f270000000000000200000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8b19927f74c743cd9a758bca5bbecbc6eb7620aa27bd494cfe5cef9bf715cb13bf47568b365be59d0f067b882f565bb80b1281aa481f675f98f2269b7cc8ac4e98d4fa7e0446da9060a3cc4126600a00bb3049912216abe85642826739cd74b7dffffefffbefffbffbfffffffffffffb1fe40000000f270000000000001400000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8e22174655f7c6123861b9c6a8e7664131cc6c5c274702ee0306ea34323146fc721b34d040f19c58a2ddf1a90166ea9d02efa7da8b829c5ca12170bd811d5fa7eb62f1f4d68c00cade4ae8949bd8a128531f93df0590446b5f0a579e854df1d1fffffffffe6fffffffffffffffffff5f0ee40000000f270000000000000100000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8d3fc240c142cfd69ffcd778b295c9b7e3691c13310bea151ffe6fc23b0af9423b94f4fddf66c11e0849f50af351be700df92647e78f3d6043fdc009ad9015714cdbae4c67bbf8c4cf75c0be24392f07005794fe49d21e36b19c13bfcebc01d2ffffffbffdfffbffffdffffffffffbff0de40000000f270000000000000600000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeae2b171686a23f3cf7a1a2c986645315c552385cbdd8d8e26565d0a15a5decdee15aab2bab3b3d19d361aa32494d9f4219fb1da9041567a93c4c9d2236f106b2e8637222771702bff61a3090aae7b3c96c6b7f9b099af4d593949d873f01cf06ffffcfffff57ffbffff7fffffffffeff1fe40000000f270000000000001600000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe985ad2e75104b814a25f0ad32e8cbac0013f5e35c6cda8a58931b15d9f2d050c96c43f8b7d97ca31ddfade46a9031eb111c21116bc2c9fd0e669653f2978149a874055698a38dc6ae2dcf985d5a77aa001935dd518d226b642ea9f433a9e00caff7fffefdbfffdffffffdffffffeffff0fe40000000f270000000000001500000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfea65479903594fefaa2cf9101d3f6c7950685409371f218ee304949c8ff0a790475e044c647a51be627d3d8381490bd19026bcedb98bb556d3b61f98e8b5d104ac48c151858183af3c84569d812a553943c7d81032ae9ea1a5bd5fa05fd08b91efefffffffffffffffdfbbffbe7dfffff1fe40000000f270000000000001200000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb166412ca8e5accde6a0b7556554473022e6caf3c4f6bc33ccb86d6ec63fd34fe97037f4a08818467a221db991fbfd0514598ac8d903df34c8f6b9a277efbeb899ddf478e803ec7a95f56569d8e671c485cba7bd693b715ae4a2aa9a72359f34f7dfffffffffffb7ff7ffffff9feffff0fe40000000f270000000000000700000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe95cdf25245a0ae301d0ac3b0ca3a6d8c1eb555e29b7303929fb40ae02b30f57bc636a849a01e4f16adef86bff1f7dae2040ac3a7fbf9ae4fc3c96d928a7c86223f912b55cb912a33471fa090750782ade302e1e826a7928d810e5e105029f80bffffeffefffffffafffbfaffffbfffff0fe40000000f270000000000000500000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfea6fe408e83618c093abc551be8944ad00c040a5d38c6514d2086a149d9485b0899c236c5755c8c263150fe7e595bada1140a3f4484885dc9cfccec53a53be949d6dc53a647f8697a128e61cd5226a77a75f6e3dcb6ea09d32ac0090b3a778a17fdfedbffffffffbf6fbdfffffffff7ff0fe40000000f270000000000000b00000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfeb5071a523ee2e87991997eb6de7372039f941ec28de0a7a37db7ca03934f85788d2bb52e8a322d62689a480fa173c4a901b5e0eccd3ec4f750507834fe492a3c2f32069e51f46dbabc98f396a854f3c6a4cdfd7c2226a4f472512176c49d4c43ddffffffffefffffbd7fddfffdff7ffe1fe40000000f270000000000001000000000000000a665a45cadc0607d6443f800b52c1093b90f88880293dbfefc47579490765fd33701000000000000619a41394302dcc6e512eb09d16202bd5b82ea2f158856be4c5a18ad8409594b3801000000000000594a69a5803accb5c54a68943e4477482c2b29357db63685a9b127a495697cfe8231c0636d4be8c77b18863cd981b0832c2832cf4be5e7aa55b37e9fe6d742936a3b98e390226683a021d5f57417bbff18116e0ae6a04136d79419c421bb6c28b328c5bd619e06d12af583a628b2cb6d5d21ec8494b1ba630ae071daf961d492e7effff67fffffffffeff7ffbeffbf7f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fc01000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fc010000")
		data := &eth.BeaconBlockBellatrix{}
		require.NoError(t, data.UnmarshalSSZ(dataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestBlockV3{BlockV3: data},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetBlockV3().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, dataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("attestation aggregation", func(t *testing.T) {
		dataByts := _byteArray("01000000000000001c00000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c83387dd0abb441a3c16886c8144098cb4cac5e363516f329c368550094fd7ff754000000b1e2f27dfac80e4f1bce84adf11acf6cdbb0d8e59a575c9795020e614eb3aa29634108c0559c04ce02b93fc9a5a8daf60485ebac039864c79d51bef54915aa8c45cbcde3215f14962be196a6b8648851c35b4a804ce8d5fb6c5ff49800ef7740685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb732000000000000000685b310217aa8ed11d15f0ac1df629f3dc95b9e0e8fc550025cb18ae36f8fb7300000000000000000000000000000000000000000000000000000000000000007c0100007c0100007c0100006502000065020000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa2ec291dd5e91096ae48b3659a7ac59567a48c030bb6ac9435d6d44ef39f3f664742f35b38cd6e41ade9ed417183cc0c0b407dfea8627ccc2275fc82ab3d2182e58a037eb144811d741d18894698396efde2b7873c2db9b712e03dfcd03705ef04000000e400000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000df7140ad4f8e394cab798d89fa7612a284de78aa004f6db9387a4269a4a0669cb62ce3f28e8731dce73d5761fdc5e30383d42a022d6e939974d0586d82270f79b38b86d17237e4241a761e239c594e7a0d4ef731470001be3b125ba515f8f215f9309a9ba12653bf9d704a4125865b9775c8a65223e3ca027781175200a2d24403")
		data := &eth.BeaconBlockAltair{}
		require.NoError(t, data.UnmarshalSSZ(dataByts))

		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestBlockV2{BlockV2: data},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		byts, err = decoded.GetBlockV2().MarshalSSZ()
		require.NoError(t, err)
		require.EqualValues(t, dataByts, byts)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("slot", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestSlot{Slot: 2},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, types.Slot(2), decoded.GetSlot())
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("epoch", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestEpoch{Epoch: 2},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, types.Epoch(2), decoded.GetEpoch())
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.PublicKey)
	})
	t.Run("sync committee", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object:          &models.SignRequestSyncCommitteeMessage{Root: []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.GetSyncCommitteeMessage())
	})
	t.Run("sync aggregator", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object: &models.SignRequestSyncAggregatorSelectionData{
				SyncAggregatorSelectionData: &eth.SyncAggregatorSelectionData{
					Slot:              types.Slot(12),
					SubcommitteeIndex: 44,
				},
			},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, 12, decoded.GetSyncAggregatorSelectionData().Slot)
		require.EqualValues(t, 44, decoded.GetSyncAggregatorSelectionData().SubcommitteeIndex)
	})
	t.Run("sync contribution proof", func(t *testing.T) {
		req := &models.SignRequest{
			PublicKey:       []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
			SigningRoot:     make([]byte, 32),
			SignatureDomain: make([]byte, 32),
			Object: &models.SignRequestContributionAndProof{
				ContributionAndProof: &eth.ContributionAndProof{
					AggregatorIndex: types.ValidatorIndex(12),
					SelectionProof:  make([]byte, 96),
					Contribution: &eth.SyncCommitteeContribution{
						Slot:              11,
						BlockRoot:         []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1},
						SubcommitteeIndex: 12,
						AggregationBits:   bitfield.NewBitvector128(),
						Signature:         make([]byte, 96),
					},
				},
			},
		}

		enc := New()
		byts, err := enc.Encode(req)
		require.NoError(t, err)

		decoded := &models.SignRequest{}
		require.NoError(t, enc.Decode(byts, decoded))
		require.EqualValues(t, 12, decoded.GetContributionAndProof().AggregatorIndex)
		require.EqualValues(t, make([]byte, 96), decoded.GetContributionAndProof().SelectionProof)
		require.EqualValues(t, 11, decoded.GetContributionAndProof().Contribution.Slot)
		require.EqualValues(t, 12, decoded.GetContributionAndProof().Contribution.SubcommitteeIndex)
		require.EqualValues(t, []byte{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 1}, decoded.GetContributionAndProof().Contribution.BlockRoot)
	})
}
