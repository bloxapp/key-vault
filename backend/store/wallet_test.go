package store_test

import (
	"context"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"os"
	"testing"

	"github.com/bloxapp/eth2-key-manager/stores/inmemory"

	eth2keymanager "github.com/bloxapp/eth2-key-manager"
	"github.com/bloxapp/eth2-key-manager/core"
	"github.com/bloxapp/eth2-key-manager/encryptor"
	"github.com/bloxapp/eth2-key-manager/encryptor/keystorev4"
	"github.com/hashicorp/vault/sdk/logical"
	"github.com/stretchr/testify/require"

	"github.com/bloxapp/key-vault/backend/store"
)

func getStorage() logical.Storage {
	return &logical.InmemStorage{}
}

func keyVault(storage core.Storage) (*eth2keymanager.KeyVault, error) {
	if err := core.InitBLS(); err != nil {
		os.Exit(1)
	}

	options := &eth2keymanager.KeyVaultOptions{}
	options.SetStorage(storage)
	return eth2keymanager.NewKeyVault(options)
}

func getWalletStorage() core.Storage {
	return store.NewHashicorpVaultStore(context.Background(), getStorage(), core.PraterNetwork)
}

func TestLegacyV0(t *testing.T) {
	inMemByts := _byteArray("7b226163636f756e7473223a2237623232333633343332333336313332333133343264333633313635363632643334333133353335326436323636363333323264333933323336333233363336363536313636333533343334323233613762323236323631373336353431363336333666373536653734353036313734363832323361323232663330323232633232363936343232336132323336333433323333363133323331333432643336333136353636326433343331333533353264363236363633333232643339333233363332333633363635363136363335333433343232326332323665363136643635323233613232363136333633366637353665373432643330323232633232373636313663363936343631373436393666366534623635373932323361376232323639363432323361323236323333363533393333333633373635326436353631333936313264333433313338363632643338363336343636326433313634333333393635363633383635333436363633333532323263323237303631373436383232336132323664326633313332333333383331326633333336333033303266333032663330326633303232326332323730373236393736346236353739323233613232333533323635333033363335333933373336333233353336333133383333363233373331363136313335333533393330333636353336333436313631363633313336333633343332333533313338363433343633333633333631363333363636333736313334363336313338333933303335333533363331333336353336333332323764326332323737363937343638363437323631373736313663353037353632346236353739323233613232363133303632333933333332333436343631333836313338363133363339333636333335333333393335333036353339333833343634363533323335363233323339333936333331333233333634333133373632363136323339333733323635363336313331363136333332363333363337333433393336333436333339363633383331333733303334333736323633333633303334333836353636333033373330333536343337363536333336363636313635333636343335363436313336323237643764222c2268696768657374417474223a223762323233393335333033383337333133383332333933333337363633363339333833323631363533393339363633393632333033363632363433313331333636363334333633333636333433313334333533313333333033333332363533333333363133333634333133373335363433393336333633323635363436343636333133363332333133303331363636333636333636333631333236313339363636353634363136343635363433373334363233383330333433373633333536343633363632323361376232323733366336663734323233613333333032633232363336663664366436393734373436353635356636393665363436353738323233613331326332323632363536313633366636653566363236633666363336623566373236663666373432323361323234313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313364323232633232373336663735373236333635323233613762323236353730366636333638323233613331326332323732366636663734323233613232343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343133643232376432633232373436313732363736353734323233613762323236353730366636333638323233613334326332323732366636663734323233613232343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343133643232376437643764222c226869676865737450726f706f73616c223a2237623232333933353330333833373331333833323339333333373636333633393338333236313635333933393636333936323330333636323634333133313336363633343336333336363334333133343335333133333330333333323635333333333631333336343331333733353634333933363336333236353634363436363331333633323331333033313636363336363336363336313332363133393636363536343631363436353634333733343632333833303334333736333335363436333636323233613762323237333663366637343232336133313263323237303732366637303666373336353732356636393665363436353738323233613338333532633232373036313732363536653734356637323666366637343232336132323466366234663662373637393632333735373535363636663433363334383739353433333333343736383538373934623737343136363663346536343533346636323662333734623439353334633339363433323733336432323263323237333734363137343635356637323666366637343232336132323732363435383463363636643730346332663339366134663636326236633730363537353331353234363664343734373438366134353731333135353632363333393535363734323537353736643530353233363535336432323263323236323666363437393232336137623232373236313665363436313666356637323635373636353631366332323361323236663733343635373730346337393535346636363438353935383335343937363462373237313730363236663464353034383436346136383431353334353632333233333330353733393462333235353662346234313737346333383537373437333439366534313537333133383537326635353561356135393736353233383432353037373732363736313663346534353331366634383737353734353339373436383535353237373538346234353734353232623736373133353638346635363734346534323438363836323662353833313432366633383535363235613531353332623532333037383731373733383661363637313737333936343436323232633232363537343638333135663634363137343631323233613762323236343635373036663733363937343566373236663666373432323361323237303466353634353533343334653664373634613331353436383736343834653434343537363334346537613461333234323537343934633339343137383536343634653535363432663462333335323533366236663364323232633232363436353730366637333639373435663633366637353665373432323361333133323338326332323632366336663633366235663638363137333638323233613232373034663536343535333433346536643736346133313534363837363438346534343435373633343465376134613332343235373439346333393431373835363436346535353634326634623333353235333662366633643232376432633232363737323631363636363639373436393232336132323431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431336432323263323236313734373436353733373436313734363936663665373332323361356237623232363136373637373236353637363137343639366636653566363236393734373332323361323234383737336433643232326332323634363137343631323233613762323236323635363136333666366535663632366336663633366235663732366636663734323233613232346636623466366237363739363233373537353536363666343336333438373935343333333334373638353837393462373734313636366334653634353334663632366233373462343935333463333936343332373333643232326332323733366637353732363336353232336137623232373236663666373432323361323234313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313431343134313364323237643263323237343631373236373635373432323361376232323732366636663734323233613232346636623466366237363739363233373537353536363666343336333438373935343333333334373638353837393462373734313636366334653634353334663632366233373462343935333463333936343332373333643232376437643263323237333639363736653631373437353732363532323361323236633337363237393633363137373332353337373531363333313437353837613463333636363266366635613339363136373532333836353632363835323738353033353530363735613534363637363637366533303334346233363738373933383461366234633638353036373338333236323736363734323639363735363431363734333437373637393635333537613734343637393761343737323634363933363535356136353561343835303539333033303539356136643339363435313339333937363433353236373464333436373666333136363662333034363733366536383435343336353464363835323266343534353462353936323661323237643564376437643764222c226e6574776f726b223a223730373937323664366636653734222c2277616c6c6574223a223762323236393634323233613232333033373635363633323335333133353264333736333331363432643334363533303333326436313631333433303264363233333635363333353339363133393335333433363336323232633232363936653634363537383464363137303730363537323232336137623232333933353330333833373331333833323339333333373636333633393338333236313635333933393636333936323330333636323634333133313336363633343336333336363334333133343335333133333330333333323635333333333631333336343331333733353634333933363336333236353634363436363331333633323331333033313636363336363336363336313332363133393636363536343631363436353634333733343632333833303334333736333335363436333636323233613232333633343332333336313332333133343264333633313635363632643334333133353335326436323636363333323264333933323336333233363336363536313636333533343334323237643263323237343739373036353232336132323438343432323764222c2277616c6c657454797065223a224844227d")
	pk := "95087182937f6982ae99f9b06bd116f463f414513032e33a3d175d9662eddf162101fcf6ca2a9fedaded74b8047c5dcf"
	inMemStorage := inmemory.NewInMemStore(core.PraterNetwork)
	require.NoError(t, json.Unmarshal(inMemByts, inMemStorage))

	hashicorp, err := store.FromInMemoryStore(context.Background(), inMemStorage, getStorage())
	require.NoError(t, err)

	// open wallet
	wallet, err := hashicorp.OpenWallet()
	require.NoError(t, err)

	account, err := wallet.AccountByPublicKey(pk)
	require.NoError(t, err)
	require.NotNil(t, account)
	require.EqualValues(t, _byteArray(pk), account.ValidatorPublicKey())

	// get highest attestation
	highestAtt := hashicorp.RetrieveHighestAttestation(account.ValidatorPublicKey())
	require.NotNil(t, highestAtt)
	require.EqualValues(t, 30, highestAtt.Slot)
	require.EqualValues(t, make([]byte, 32), highestAtt.BeaconBlockRoot)

	// get highest block
	highestProp := hashicorp.RetrieveHighestProposal(account.ValidatorPublicKey())
	require.NotNil(t, highestAtt)
	fmt.Printf("%s\n", hex.EncodeToString(highestProp.StateRoot))
	require.EqualValues(t, _byteArray("add5cb7e6a4bffd8ce7fe9697aed511661861e312ad546dcf5480159698f47a5"), highestProp.StateRoot)
}

func TestOpeningAccounts(t *testing.T) {
	storage := getWalletStorage()
	kv, err := keyVault(storage)
	require.NoError(t, err)

	wallet, err := kv.Wallet()
	require.NoError(t, err)

	seed := _byteArray("0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1fff")

	for i := 0; i < 10; i++ {
		testName := fmt.Sprintf("adding and fetching account: %d", i)
		t.Run(testName, func(t *testing.T) {
			// create
			a, err := wallet.CreateValidatorAccount(seed, nil)
			require.NoError(t, err)

			// open
			a1, err := wallet.AccountByPublicKey(hex.EncodeToString(a.ValidatorPublicKey()))
			require.NoError(t, err)

			a2, err := wallet.AccountByID(a.ID())
			require.NoError(t, err)

			// verify
			for _, fetchedAccount := range []core.ValidatorAccount{a1, a2} {
				require.Equal(t, a.ID().String(), fetchedAccount.ID().String())
				require.Equal(t, a.Name(), fetchedAccount.Name())
				require.Equal(t, a.ValidatorPublicKey(), fetchedAccount.ValidatorPublicKey())
				require.Equal(t, a.WithdrawalPublicKey(), fetchedAccount.WithdrawalPublicKey())
			}
		})
	}
}

func TestNonExistingWallet(t *testing.T) {
	storage := getWalletStorage()
	w, err := storage.OpenWallet()
	require.NotNil(t, err)
	require.EqualError(t, err, "wallet not found")
	require.Nil(t, w)
}

func TestWalletStorage(t *testing.T) {
	storage := getWalletStorage()
	tests := []struct {
		name       string
		walletName string
		encryptor  encryptor.Encryptor
		password   []byte
		error
	}{
		{
			name:       "serialization and fetching",
			walletName: "test1",
		},
		{
			name:       "serialization and fetching with encryptor",
			walletName: "test2",
			encryptor:  keystorev4.New(),
			password:   []byte("password"),
		},
	}

	kv, err := keyVault(storage)
	require.NoError(t, err)

	wallet, err := kv.Wallet()
	require.NoError(t, err)

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			// set encryptor
			if test.encryptor != nil {
				storage.SetEncryptor(test.encryptor, test.password)
			} else {
				storage.SetEncryptor(nil, nil)
			}

			err = storage.SaveWallet(wallet)
			if err != nil {
				if test.error != nil {
					require.Equal(t, test.error.Error(), err.Error())
				} else {
					t.Error(err)
				}
				return
			}

			// fetch wallet by id
			fetched, err := storage.OpenWallet()
			if err != nil {
				if test.error != nil {
					require.Equal(t, test.error.Error(), err.Error())
				} else {
					t.Error(err)
				}
				return
			}

			require.NotNil(t, fetched)
			require.NoError(t, test.error)

			// assert
			require.Equal(t, wallet.ID(), fetched.ID())
			require.Equal(t, wallet.Type(), fetched.Type())
		})
	}

	// reset
	storage.SetEncryptor(nil, nil)
}
